% Remember to use the lgrind style

\Head{}
\File{example\-real.cpp.lineno}{2014}{12}{18}{0:10}{1498}
\L{\LB{\N{1}_\V{:}_\K{\#include}_\<\V{stdio}.\V{h}\>}}
\L{\LB{\N{2}_\V{:}_\K{\#include}_\<\V{assert}.\V{h}\>}}
\L{\LB{\N{3}_\V{:}_\K{\#include}_\<\V{malloc}.\V{h}\>}}
\L{\LB{\N{4}_\V{:}_\K{\#include}_\<\V{string}.\V{h}\>}}
\L{\LB{\N{5}_\V{:}_\K{\#include}_\<\V{stdlib}.\V{h}\>}}
\L{\LB{\N{6}_\V{:}_\K{\#include}_\<\V{pthread}.\V{h}\>}}
\L{\LB{\N{7}_\V{:}_}}
\L{\LB{\N{8}_\V{:}_\K{\#define}_\V{MAX\_THREADS}_(\N{100})}}
\L{\LB{\N{9}_\V{:}_\V{pthread\_barrier\_t}_\V{barrier};}}
\L{\LB{\N{10}\V{:}_\V{pthread\_mutex\_t}_\V{m}_=_\V{PTHREAD\_MUTEX\_INITIALIZER};}}
\L{\LB{\N{11}\V{:}_\V{pthread\_t}_\V{threads}[\V{MAX\_THREADS}];}}
\L{\LB{\N{12}\V{:}_\K{void}*_\V{worker}(\K{void}_*\V{arg});}}
\L{\LB{\N{13}\V{:}_}}
\L{\LB{\N{14}\V{:}_\K{char}_\V{data}[\N{100}];}}
\L{\LB{\N{15}\V{:}_\K{int}_\V{size};_\C{}//_size_of_\CE{}\V{data}\C{}\CE{}}}
\L{\LB{\N{16}\V{:}_\K{int}_\V{nthread};_\C{}//_total_number_of_threads\CE{}}}
\L{\LB{\N{17}\V{:}_\K{unsigned}_\K{long}_\V{result}_=_\N{0};}}
\L{\LB{\N{18}\V{:}_}}
\index{main}\Proc{main}\L{\LB{\N{19}\V{:}_\K{int}_\V{main}(\K{int}_\V{argc},_\K{char}_*\V{argv}[\,])_\{}}
\L{\LB{\N{20}\V{:}}\Tab{6}{\V{nthread}_=_\V{atoi}(\V{argv}[\N{1}]);}}
\L{\LB{\N{21}\V{:}}\Tab{6}{\V{size}_=_\V{atoi}(\V{argv}[\N{2}]);}}
\L{\LB{\N{22}\V{:}}\Tab{6}{\V{assert}(\V{nthread}\>\N{0}_\&\&_\V{size}\>=\V{nthread});}}
\L{\LB{\N{23}\V{:}}\Tab{6}{\V{pthread\_barrier\_init}(\&\V{barrier},_\V{NULL},_\V{nthread});}}
\L{\LB{\N{24}\V{:}}\Tab{6}{\K{for}(\K{long}_\V{i}=\N{1};_\V{i}\<\V{nthread};++\V{i})}}
\L{\LB{\N{25}\V{:}}\Tab{8}{\V{pthread\_create}(\&\V{threads}[\V{i}],_\V{NULL},_\V{worker},_(\K{void}*)\V{i});}}
\L{\LB{\N{26}\V{:}}\Tab{6}{\V{worker}(\N{0});_\C{}//_participate_in_computation\CE{}}}
\L{\LB{\N{27}\V{:}}\Tab{6}{\C{}//_missing_\CE{}\V{pthread\_join}()\C{}\CE{}}}
\L{\LB{\N{28}\V{:}}\Tab{6}{\K{if}(\V{atoi}(\V{argv}[\N{3}])_==_\N{1})}}
\L{\LB{\N{29}\V{:}}\Tab{8}{\V{result}_+=_\N{10};_\C{}//_race_with_line_15\CE{}}}
\L{\LB{\N{30}\V{:}}\Tab{6}{\V{printf}(\S{}\3result_=_\%lu\2n\3\SE{},_\V{result});}}
\L{\LB{\N{31}\V{:}}\Tab{6}{\K{return}_\N{0};}}
\L{\LB{\N{32}\V{:}_\}}}
\index{worker}\Proc{worker}\L{\LB{\N{33}\V{:}_\K{void}*_\V{worker}(\K{void}_*\V{arg})_\{}}
\L{\LB{\N{34}\V{:}}\Tab{6}{\K{int}_\V{start}_=_\V{size}/\V{nthread}_*_(\K{long})\V{arg};}}
\L{\LB{\N{35}\V{:}}\Tab{6}{\K{int}_\V{end}_=_\V{size}/\V{nthread}_*_((\K{long})\V{arg}+\N{1});}}
\L{\LB{\N{36}\V{:}}\Tab{6}{\V{printf}(\S{}\3start=\%d,_end=\%d\2n\3\SE{},_\V{start},_\V{end});}}
\L{\LB{\N{37}\V{:}}\Tab{6}{\K{for}(\K{int}_\V{i}=\V{start};_\V{i}\<=\V{end};_++\V{i})}}
\L{\LB{\N{38}\V{:}}\Tab{8}{\V{data}[\V{i}]_=_\V{data}[\V{i}]_*_\N{50};_\C{}//_race_with_line_8_and_9\CE{}}}
\L{\LB{\N{39}\V{:}}\Tab{6}{\V{pthread\_mutex\_lock}(\&\V{m});}}
\L{\LB{\N{40}\V{:}}\Tab{6}{\V{result}_+=_\N{10000};}}
\L{\LB{\N{41}\V{:}}\Tab{6}{\V{pthread\_mutex\_unlock}(\&\V{m});}}
\L{\LB{\N{42}\V{:}_\}}}
\index{atoi}\Proc{atoi}\L{\LB{\N{43}\V{:}_\K{int}_\V{atoi}(\K{const}_\K{char}_*\V{str})_\{}}
\L{\LB{\N{44}\V{:}}\Tab{6}{\K{int}_\V{number}_=_\N{0},_\V{i}_=_\N{0};}}
\L{\LB{\N{45}\V{:}}\Tab{6}{\K{for}(\V{i}=\N{0};_\V{str}[\V{i}]\>=\S{}{'}0{'}\SE{}\&\&\V{str}[\V{i}]\<=\S{}{'}9{'}\SE{};_++\V{i})}}
\L{\LB{\N{46}\V{:}}\Tab{8}{\V{number}_=_\V{number}_*_\N{10}_+_(\V{str}[\V{i}]\-\S{}{'}0{'}\SE{});}}
\L{\LB{\N{47}\V{:}}\Tab{6}{\K{return}_\V{number};}}
\L{\LB{\N{48}\V{:}_\}}}
